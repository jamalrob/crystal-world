{% extends "admin/layouts/base.html" %}
{% block content %}
<ul id="imagelist">
{% for im in images %}
  <li data-url="{{ im }}">
    <a
      href="#"
      class="imglink"
      hx-get="/admin/get_image/{{ im }}"
      hx-trigger="load"
      _="on click call showModal('{{ im }}')"
    >
      <span class="spinner" class="imgLoading"></span>
    </a>
    <button class="copymd icon" title="Copy markdown link" data-url="{{ im }}">
      <svg data-url="{{ im }}" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
    </button>
  </li>
{% endfor %}
</ul>

<div class="modal-container"
_="on click
    if the target of the event does not match <div.modal/> and the target of the event is not in <div.modal/>
      remove .visible from .modal-container
    end
  end
  "
>
  <div class="modal image">
      <button
        class="icon close"
        title="Close"
        _="on click remove .visible from .modal-container"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-circle"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
      </button>
      <div id="answerLoading"></div>
      <div class="modal-inner">
      </div>
  </div>
</div>

<script>
  document.querySelectorAll(".copymd").forEach(el => {
    el.addEventListener("click", function(ev) {
      const url = ev.target.dataset.url;
      const md = `![alt text](${url})`;
      navigator.clipboard.writeText(md);
      console.log('Copied');
    })
  })
</script>
<script type="text/hyperscript">
  on keyup[key is 'Escape']
    remove .visible from .modal-container
  end

  def do_html(md)
    make a showdown.Converter called converter
    set html to converter.makeHtml(md.replaceAll('/bucket/', '{{ imagekit_bucket }}/'))
    put html into #pre-preview
    call hljs.highlightAll()
  end

  def showModal(imgurl)
    ---show <button.close/>
    add .visible to .modal-container
    set img_html to "<img src=\"https://ik.imagekit.io/alistairrobinson/blog/tr:w-800/" + imgurl + "\">"
    put img_html into .modal-inner
  end
</script>
<style>
  #imagelist {
    display: flex;
    flex-wrap: wrap;
    list-style: none;
  }
  #imagelist li {
    margin: 5px 5px 35px;
    background: rgb(7, 50, 83);
    display: flex;
    flex-direction: column;
    position: relative;
    width: 170px;
    height: 250px;
  }
  #imagelist li a {
    padding: 10px;
    border-radius: 3px;
    display: block;
    display: flex;
    align-items: center;
    height: 100%;
    justify-content: center;
  }
  #imagelist li a:hover {
    background-color: rgb(8, 32, 50);
  }
  #imagelist button {
    position: absolute;
    right: 0;
    bottom: -28px;
  }
  .modal.image > .modal-inner {
    padding: 20px;
    display: flex;
    align-content: center;
    justify-content: center;
  }
</style>
{% endblock %}