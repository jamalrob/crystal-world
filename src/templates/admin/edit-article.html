{% extends "admin/layouts/base.html" %}
{% block content %}
<div class="supertitle">
  Editing: <em>{{ article.title }}</em>
  <span id="link-container">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
    <a href="#">
      Article properties
    </a>
  </span>
</div>
<div class="edit-container">
  <section class="edit">
    <div class="editable" contenteditable="true"
    _=" on input
          call do_html(me.innerText)
        on scroll
          set scrollTop of #pre-preview to my.scrollTop
        on keydown[key is 'Tab']
          halt the event then call document.execCommand('insertText', false, '&#009')
        on keydown[key is 'b' and ctrlKey is true]
          halt the event
          call doFontStyle('**') then call do_html(me.innerText)
        on keydown[key is 'i' and ctrlKey is true]
          halt the event
          call doFontStyle('_') then call do_html(me.innerText)
        "
    >{{ article.md }}</div>
  </section>
  <section class="preview">
    <!-- href="/admin/edit/{{ article.slug }}/preview" -->
    <a  href="/get_preview_html"
        title="Full preview"
        target="previewArticle"
        hx-post="/get_preview_html"
        hx-vals="js:{
            markdown: document.querySelector('.editable').innerText
        }"
        hx-target="#pre-preview"
        hx-indicator=""
        hx-on::before-request=""
        hx-on::after-request="setLocalStorage()"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
    </a>
    <div id="pre-preview">
    {{ article.html|safe }}
    </div>
  </section>
</div>
<script>
  // ********************************************************
  // Prevent users pasting in anything other than usual stuff
  // ********************************************************
  const el = document.querySelector('.editable');
  el.addEventListener('paste', (e) => {
    // Get user's pasted data
    let data = e.clipboardData.getData('text/html') ||
        e.clipboardData.getData('text/plain');
    // Filter out everything except simple text and allowable HTML elements
    let regex = /<(?!(\/\s*)?(a|b|i|em|s|code|pre|strong|u)[>,\s])([^>])*>/g;
    data = data.replace(regex, '');
    // Insert the filtered content
    document.execCommand('insertHTML', false, data);
    // Prevent the standard paste behavior
    e.preventDefault();
  });
</script>
<script type="text/hyperscript">
  def doFontStyle(mk)
    set div to <div.editable/>
    if window.getSelection
      set sel to window.getSelection()
      set replacementText to mk.concat(sel, mk)
      if sel.rangeCount is greater than 0
        set range to sel.getRangeAt(0)
        call range.deleteContents()
        call range.insertNode(document.createTextNode(replacementText))
      end
    end
  end

  def do_html(md)
    make a showdown.Converter called converter
    set html to converter.makeHtml(md.replaceAll('/bucket/', '{{ imagekit_bucket }}/'))
    put html into #pre-preview
    hljs.highlightAll()
  end

  def setLocalStorage()
    set localStorage.previewHtml to innerHTML of #pre-preview
    go to '/admin/edit/{{ article.slug }}/preview'
  end
</script>
<style>
.supertitle {
  font-size: 0.78rem;
  margin-bottom: 10px;
  width: 50%;
}
.supertitle #link-container{
  float: right;
  margin-right: 13px;
}
.supertitle #link-container svg {
  vertical-align: sub;
}
.edit-container {
  display: flex;
  flex-direction: row;
}
.edit-container section {
  width: 50%;
}
.edit-container section:first-child {
  margin-right: 25px;
}
.edit-container div.editable {
  white-space: pre-wrap;
  background-color: #1c2125;
  line-height: 1.34rem;
}
#article-edit-box {
  background: rgb(232, 229, 229);
  color: #222;
  padding: 20px;
  border-radius: 3px;
  font-size: 0.8rem;
  width: 100%;
  height: 80vh;
  /*white-space: pre;*/
}
textarea,
pre, #pre-preview, .editable {
  -moz-tab-size : 4;
  -o-tab-size : 4;
  tab-size : 4;
}
section.preview svg {
  float: right;
  margin-top: -30px
}
div#pre-preview, div.editable {
  height: 80vh;
  overflow: auto;
  font-size: 0.84rem;
  line-height: 1.38rem;
  background-color: #08416d;
  padding: 10px 15px 0 15px;
  border-radius: 3px;
}
div#pre-preview blockquote {
  border-radius: 2px;
  padding: 15px 25px 5px 60px;
  margin-left: 0;
  margin-right: 25px;
  position: relative;
  font-style: italic;
}
div#pre-preview blockquote::before{
  font-family: "Roboto";
  content: "\201C";
  font-size: 5em;
  position: absolute;
  left: 5px;
  top: 35px;
}
div#pre-preview pre {
  background: #1f232b;
  border-radius: 2px;
  margin-left: 0px;
  margin-right: 10px;
  position: relative;
  overflow: auto;
  line-height: 1.2rem;
}
div#pre-preview pre code {
  font-family: 'Ubuntu Mono', 'Code New Roman', 'Source Code Pro', monospace !important;
  background: #1f232b;
}
div#pre-preview img {
    max-width: 95%;
    display: block;
}
div#pre-preview img+em {
    font-size: 0.8rem;
}
div#pre-preview p:first-child {
  margin-top: 0;
}
</style>
{% endblock %}